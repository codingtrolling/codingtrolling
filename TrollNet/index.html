<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrollNET | Full Social Suite</title>
    
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg: #050505;
            --nav: #121212;
            --card: #1a1a1a;
            --primary: #FF4500;
            --accent: #00FF41;
            --text: #ffffff;
            --border: #2a2a2a;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        /* --- HEADER & NAVIGATION --- */
        header {
            background: var(--nav);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-icons { display: flex; gap: 20px; align-items: center; }
        .nav-icons i { font-size: 20px; cursor: pointer; position: relative; }
        .notif-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 50%;
            display: none;
        }

        /* --- LAYOUT --- */
        .container { display: flex; width: 100%; }
        
        main { flex: 1; max-width: 600px; margin: 0 auto; padding: 10px; }

        /* --- FRIEND LIST SIDEBAR --- */
        #sidebar {
            width: 250px;
            background: var(--nav);
            border-left: 1px solid var(--border);
            height: calc(100vh - 60px);
            position: sticky;
            top: 60px;
            padding: 15px;
            transition: 0.3s;
        }

        @media (max-width: 800px) {
            #sidebar {
                position: fixed;
                right: -250px;
                z-index: 999;
            }
            #sidebar.open { right: 0; }
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .friend-item:hover { background: var(--card); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }

        /* --- POST CREATOR --- */
        .post-creator {
            background: var(--card);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        textarea {
            width: 100%; background: transparent; border: none; color: white;
            font-size: 16px; resize: none; outline: none;
        }

        .btn-post {
            background: var(--primary); color: white; border: none;
            padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer;
        }

        /* --- CHAT BOX --- */
        #chat-window {
            position: fixed;
            bottom: 0;
            right: 270px;
            width: 300px;
            height: 400px;
            background: var(--card);
            border: 1px solid var(--primary);
            border-radius: 10px 10px 0 0;
            display: none;
            flex-direction: column;
            z-index: 2000;
        }

        @media (max-width: 600px) {
            #chat-window { right: 0; width: 100%; height: 50%; }
        }

        .chat-header {
            padding: 10px;
            background: var(--primary);
            display: flex;
            justify-content: space-between;
        }

        #chat-messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 14px; }
        .msg { margin-bottom: 8px; padding: 5px 10px; border-radius: 5px; background: #333; width: fit-content; }
        .msg.me { background: var(--primary); margin-left: auto; }

        /* --- UTILS --- */
        .toast {
            position: fixed; top: 70px; right: 20px; background: var(--accent);
            color: black; padding: 10px 20px; border-radius: 5px; display: none; z-index: 3000;
        }

    </style>
</head>
<body>

    <div id="toast-msg" class="toast"></div>

    <header>
        <div style="color: var(--primary); font-weight: 900; font-size: 22px;">TrollNET</div>
        <div class="nav-icons">
            <i class="fa fa-bell" onclick="showNotifs()"><span id="notif-count" class="notif-badge">0</span></i>
            <i class="fa fa-users" onclick="toggleSidebar()"></i>
            <img id="my-pic" src="" style="width:30px; border-radius:50%; border:1px solid white;">
        </div>
    </header>

    <div class="container">
        <main>
            <div class="post-creator">
                <textarea id="post-input" placeholder="What's the tea, Troll?"></textarea>
                <div style="display:flex; justify-content: space-between; align-items:center; margin-top:10px;">
                    <input type="file" id="media-input" hidden onchange="previewMedia(event)">
                    <label for="media-input" style="color:var(--accent); cursor:pointer;"><i class="fa fa-image"></i> 20MB</label>
                    <button class="btn-post" onclick="sendPost()">Post</button>
                </div>
                <img id="post-preview" style="width:100%; display:none; margin-top:10px; border-radius:8px;">
            </div>

            <div id="feed"></div>
        </main>

        <aside id="sidebar">
            <h3 style="color:var(--primary); font-size:16px;">ONLINE TROLLS</h3>
            <div id="friend-list">
                </div>
        </aside>
    </div>

    <div id="chat-window">
        <div class="chat-header">
            <span id="chat-target-name">Chat</span>
            <i class="fa fa-times" style="cursor:pointer;" onclick="closeChat()"></i>
        </div>
        <div id="chat-messages"></div>
        <div style="display:flex; padding:10px; border-top:1px solid var(--border);">
            <input type="text" id="chat-input" style="flex:1; background:transparent; color:white; border:none; outline:none;" placeholder="Type a message...">
            <i class="fa fa-paper-plane" style="color:var(--primary); cursor:pointer;" onclick="sendPrivateMsg()"></i>
        </div>
    </div>

    <script>
        const socket = io("https://suscraft-backend-production.up.railway.app");
        let me = null;
        let activeChatId = null;
        let mediaData = null;

        // 1. IDENTITY SETUP
        window.onload = () => {
            let saved = localStorage.getItem('trollUser');
            if (saved) {
                me = JSON.parse(saved);
            } else {
                let name = prompt("Enter Troll Name:");
                me = {
                    id: "TR_" + Math.floor(Math.random() * 99999),
                    name: name || "GhostTroll",
                    pic: "https://api.dicebear.com/7.x/bottts/svg?seed=" + name
                };
                localStorage.setItem('trollUser', JSON.stringify(me));
            }
            document.getElementById('my-pic').src = me.pic;
            socket.emit('registerUser', me.id);
            toast("Connected as " + me.name);
        };

        // 2. FEED LOGIC
        function sendPost() {
            const txt = document.getElementById('post-input').value;
            if(!txt && !mediaData) return;

            const post = {
                id: Date.now(),
                uName: me.name,
                uPic: me.pic,
                content: txt,
                media: mediaData
            };
            socket.emit('newTrollPost', post);
            
            // Reset
            document.getElementById('post-input').value = "";
            document.getElementById('post-preview').style.display = 'none';
            mediaData = null;
        }

        socket.on('feedUpdate', (posts) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = posts.map(p => `
                <div style="background:var(--card); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border);">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <img src="${p.uPic}" style="width:35px; border-radius:50%;">
                        <b>${p.uName}</b>
                    </div>
                    <div>${p.content}</div>
                    ${p.media ? `<img src="${p.media}" style="width:100%; border-radius:8px; margin-top:10px;">` : ''}
                </div>
            `).join('');
        });

        // 3. FRIEND & CHAT LOGIC
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        socket.on('updateOnlineList', (users) => {
            const list = document.getElementById('friend-list');
            list.innerHTML = users.filter(u => u !== me.id).map(uId => `
                <div class="friend-item" onclick="openChat('${uId}')">
                    <div class="status-dot"></div>
                    <span>${uId}</span>
                </div>
            `).join('');
        });

        function openChat(uId) {
            activeChatId = uId;
            document.getElementById('chat-target-name').innerText = "Chat with " + uId;
            document.getElementById('chat-window').style.display = 'flex';
            document.getElementById('chat-messages').innerHTML = ""; 
        }

        function closeChat() { document.getElementById('chat-window').style.display = 'none'; }

        function sendPrivateMsg() {
            const msg = document.getElementById('chat-input').value;
            if(!msg) return;
            socket.emit('sendPrivateMessage', {
                toUserId: activeChatId,
                fromName: me.name,
                fromId: me.id,
                message: msg
            });
            addMsgToBox("me", msg);
            document.getElementById('chat-input').value = "";
        }

        socket.on('receivePrivateMessage', (data) => {
            if(activeChatId === data.fromId) {
                addMsgToBox("them", data.message);
            }
            toast("New message from " + data.from);
            updateNotifBadge(1);
        });

        // 4. UTILS
        function previewMedia(e) {
            const file = e.target.files[0];
            if(file.size > 20*1024*1024) return alert("Too large!");
            const reader = new FileReader();
            reader.onload = () => {
                mediaData = reader.result;
                document.getElementById('post-preview').src = mediaData;
                document.getElementById('post-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function addMsgToBox(type, text) {
            const box = document.getElementById('chat-messages');
            box.innerHTML += `<div class="msg ${type === 'me' ? 'me' : ''}">${text}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function toast(m) {
            const t = document.getElementById('toast-msg');
            t.innerText = m; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function updateNotifBadge(n) {
            const b = document.getElementById('notif-count');
            let count = parseInt(b.innerText) + n;
            b.innerText = count;
            b.style.display = count > 0 ? 'block' : 'none';
        }
    </script>
</body>
</html>
