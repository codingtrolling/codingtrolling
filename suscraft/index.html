<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SusCraft Mobile // 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; }
        #crosshair { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; pointer-events: none; z-index: 10; }
        .joystick-base { width: 120px; height: 120px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; position: fixed; bottom: 40px; left: 40px; }
        .joystick-stick { width: 50px; height: 50px; background: rgba(59, 130, 246, 0.8); border-radius: 50%; position: absolute; top: 35px; left: 35px; }
    </style>
</head>
<body>

    <div id="crosshair">+</div>

    <div class="fixed top-4 left-4 z-50 pointer-events-auto">
        <div class="bg-slate-900/90 p-4 rounded-2xl border border-slate-700 text-white">
            <h1 class="text-xs font-black text-blue-500 italic uppercase">SusCraft Multiplayer</h1>
            <p id="room-id" class="text-[9px] text-slate-500 font-mono mt-1">Status: Offline</p>
            <div class="flex gap-2 mt-2">
                <button onclick="hostWorld()" class="bg-blue-600 px-3 py-1 rounded text-[10px] font-bold">HOST</button>
                <button onclick="joinWorld()" class="bg-slate-700 px-3 py-1 rounded text-[10px] font-bold">JOIN</button>
            </div>
        </div>
    </div>

    <div class="fixed bottom-10 right-10 z-50 flex flex-col gap-4 pointer-events-auto">
        <button onclick="placeBlock()" class="w-20 h-20 bg-blue-600 rounded-full border-4 border-white text-white font-black shadow-2xl active:scale-90">BUILD</button>
        <button onclick="jump()" class="w-16 h-16 bg-slate-800/80 rounded-full border-2 border-white/20 text-white font-bold active:scale-90">JUMP</button>
    </div>

    <div class="joystick-base" id="joyBase">
        <div class="joystick-stick" id="joyStick"></div>
    </div>

    <script>
        // --- 1. CORE ENGINE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 7.5);
        scene.add(light, new THREE.AmbientLight(0x404040));

        // --- 2. PHYSICS & WORLD ---
        let velocityY = 0;
        const gravity = -0.015;
        const blocks = [];
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const materials = {
            grass: new THREE.MeshStandardMaterial({ color: 0x4d9c41 }),
            dirt: new THREE.MeshStandardMaterial({ color: 0x8b4513 })
        };

        function addBlock(x, y, z, type = 'grass') {
            const cube = new THREE.Mesh(geometry, materials[type]);
            cube.position.set(Math.round(x), Math.round(y), Math.round(z));
            scene.add(cube);
            blocks.push(cube);
        }

        // Build flat floor
        for(let x=-10; x<10; x++) for(let z=-10; z<10; z++) addBlock(x, 0, z);
        camera.position.set(0, 3, 5);

        // --- 3. MOBILE CONTROLS (JOYSTICK) ---
        let moveX = 0, moveZ = 0;
        const joyBase = document.getElementById('joyBase');
        const joyStick = document.getElementById('joyStick');

        joyBase.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const rect = joyBase.getBoundingClientRect();
            const centerX = rect.left + 60, centerY = rect.top + 60;
            let dx = touch.clientX - centerX, dy = touch.clientY - centerY;
            const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
            const angle = Math.atan2(dy, dx);
            
            joyStick.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
            moveX = (Math.cos(angle) * dist) / 50;
            moveZ = (Math.sin(angle) * dist) / 50;
        });

        joyBase.addEventListener('touchend', () => {
            joyStick.style.transform = 'translate(0,0)';
            moveX = 0; moveZ = 0;
        });

        // Touch to Look
        let lastX, lastY;
        window.addEventListener('touchmove', (e) => {
            if(e.target.closest('.joystick-base') || e.target.tagName === 'BUTTON') return;
            const t = e.touches[0];
            if(lastX) {
                camera.rotation.y -= (t.clientX - lastX) * 0.005;
                camera.rotation.x -= (t.clientY - lastY) * 0.005;
            }
            lastX = t.clientX; lastY = t.clientY;
        });
        window.addEventListener('touchend', () => { lastX = null; });

        function jump() { if(camera.position.y <= 1.7) velocityY = 0.25; }

        function placeBlock() {
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            const pos = camera.position.clone().add(dir.multiplyScalar(3));
            addBlock(pos.x, pos.y, pos.z, 'dirt');
            if(conn) conn.send({type: 'build', x: pos.x, y: pos.y, z: pos.z});
        }

        // --- 4. MULTIPLAYER ---
        let peer, conn;
        const username = localStorage.getItem('suscraft_username') || "Player" + Math.floor(Math.random()*999);

        function hostWorld() {
            peer = new Peer(username.toLowerCase().replace(/\s/g, '-'));
            peer.on('open', id => document.getElementById('room-id').innerText = "ID: " + id);
            peer.on('connection', c => { conn = c; setupConn(); });
        }

        function joinWorld() {
            const id = prompt("Room ID:");
            peer = new Peer();
            peer.on('open', () => { conn = peer.connect(id); setupConn(); });
        }

        const remotes = {};
        function setupConn() {
            conn.on('data', d => {
                if(d.type === 'move') {
                    if(!remotes[d.id]) {
                        remotes[d.id] = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({color: 0xff0000}));
                        scene.add(remotes[d.id]);
                    }
                    remotes[d.id].position.set(d.x, d.y, d.z);
                }
                if(d.type === 'build') addBlock(d.x, d.y, d.z, 'dirt');
            });
        }

        // --- 5. LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            
            // Physics
            velocityY += gravity;
            camera.position.y += velocityY;
            if(camera.position.y < 1.6) { camera.position.y = 1.6; velocityY = 0; }

            // Movement
            camera.translateZ(moveZ * 0.15);
            camera.translateX(moveX * 0.15);

            if(conn && conn.open) conn.send({type: 'move', id: username, x: camera.position.x, y: camera.position.y, z: camera.position.z});

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
